// This file was generated by SquareLine Studio
// SquareLine Studio version: SquareLine Studio 1.5.2
// LVGL version: 8.3.11
// Project name: ChirpyUI

#include "ui.h"
#include "common.h"
#include "structs.h"
#include <esp_err.h>
#include "esp_log.h"
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"

void loraEmergency(lv_event_t * e)
{
	if (common_sendLoraEmoji(ALERT) == ESP_OK) //TODO: Replace this function with a special function that also sends GPS coords
	{
		MessageSentSuccessStart_Animation(ui_MessageSendCheckMark, 0);
		MessageSentSuccessEnd_Animation(ui_MessageSendCheckMark, 0);
	}
}

void successAnimationFunc(lv_obj_t *TargetObject)
{
	// Unhide and reset opacity
	lv_obj_clear_flag(TargetObject, LV_OBJ_FLAG_HIDDEN);
	lv_obj_set_style_opa(TargetObject, LV_OPA_TRANSP, 0); // Start transparent

	// Start the animation
	MessageSentSuccessStart_Animation(TargetObject, 0);

}

void loraSendLike(lv_event_t * e)
{
	if (common_sendLoraEmoji(THUMB_UP) == ESP_OK)
	{
		successAnimationFunc(ui_MessageSendCheckMark);
	}
}

void loraSendWave(lv_event_t * e)
{
	if (common_sendLoraEmoji(WAVE) == ESP_OK)
	{
		successAnimationFunc(ui_MessageSendCheckMark);
	}
}

void loraSendHeart(lv_event_t * e)
{
	if (common_sendLoraEmoji(HEART) == ESP_OK)
	{
		successAnimationFunc(ui_MessageSendCheckMark);
	}
}

void loraSendParty(lv_event_t * e)
{
	if (common_sendLoraEmoji(PARTY) == ESP_OK)
	{
		successAnimationFunc(ui_MessageSendCheckMark);
	}
}

void loraSendMessageFromBox(lv_event_t * e)
{
	const char *text = lv_textarea_get_text(ui_MessageInputBox);
	if (common_sendLoraMessage(text) == ESP_OK)
	{
		lv_obj_clear_flag(ui_MessageSendCheckMark, LV_OBJ_FLAG_HIDDEN);
		lv_obj_set_style_opa(ui_MessageSendCheckMark, LV_OPA_0, LV_PART_MAIN | LV_STATE_DEFAULT);

		lv_textarea_set_text(ui_MessageInputBox, ""); // clear input box after sending
		lv_textarea_set_placeholder_text(ui_MessageInputBox, "Type a message...");
		MessageSentSuccessStart_Animation(ui_MessageSendCheckMark, 0);
		MessageSentSuccessEnd_Animation(ui_MessageSendCheckMark, 0);
		lv_obj_add_flag(ui_MessageSendCheckMark, LV_OBJ_FLAG_HIDDEN);
	}
}

void loraChangeGroup(lv_event_t * e)
{
	char buf[16]; // buffer for the selected text
	lv_roller_get_selected_str(ui_GroupSelector, buf, sizeof(buf));
	ESP_LOGI("UI", "Selected roller item: %s", buf);

	// format "Gr. x", extract the number
	int group = 0;
	if (sscanf(buf, "Gr. %d", &group) == 1)
	{
		if (group >= 0 && group <= 9)
		{
			globalUserData.groupId = group;
			ESP_LOGI("UI", "Updated globalUserData.groupId to %d", group);
			lv_label_set_text_fmt(ui_GroupNr, "Group: %d", group);
		}
		else
		{
			ESP_LOGW("UI", "Group number out of range: %d", group);
		}
	}
	else
	{
		ESP_LOGW("UI", "Failed to parse group number from: %s", buf);
	}
}

void ChangeUserPiggy(lv_event_t * e)
{
	globalUserData.userId = PIGGY;
	lv_img_set_src(ui_CurrentAvatarImage, &ui_img_piggy_png);
	successAnimationFunc(ui_AvatarUpdateSuccessImage);
}

void ChangeUserFroggy(lv_event_t * e)
{
	globalUserData.userId = FROGGY;
	lv_img_set_src(ui_CurrentAvatarImage, &ui_img_froggy_png);	
	successAnimationFunc(ui_AvatarUpdateSuccessImage);
}

void ChangeUserHorsy(lv_event_t * e)
{
	globalUserData.userId = HORSY;
	lv_img_set_src(ui_CurrentAvatarImage, &ui_img_horsy_png);
	successAnimationFunc(ui_AvatarUpdateSuccessImage);
}

void ChangeUserPandy(lv_event_t * e)
{
	globalUserData.userId = PANDY;
	lv_img_set_src(ui_CurrentAvatarImage, &ui_img_pandy_png);
	successAnimationFunc(ui_AvatarUpdateSuccessImage);
}
